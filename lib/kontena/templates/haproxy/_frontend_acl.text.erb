<% services.each do |service| %>
  <% service.virtual_hosts.each do |virtual_host| %>
    <% if virtual_host[0] == '*' %>
    acl host_<%= service.name %> hdr_end(host) -i <%= virtual_host.sub('*.', '.') %>
    <% else %>
    acl host_<%= service.name %> hdr(host) -i <%= virtual_host %>
    <% end %>
  <% end %>
  <% if service.virtual_path %>
    acl host_<%= service.name %>_virtual_path url_beg <%= service.virtual_path %>
  <% end %>
<% end %>

<% services.each do |service| %>
  <% if service.virtual_hosts.size > 0 && service.virtual_path %>
    use_backend <%= service.name %> if host_<%= service.name %> host_<%= service.name %>_virtual_path
  <% end %>

  <% if service.virtual_hosts.size > 0 && !service.virtual_path %>
    use_backend <%= service.name %> if host_<%= service.name %>
  <% end %>

  <% if service.virtual_path && service.virtual_hosts.size == 0 %>
    use_backend <%= service.name %> if host_<%= service.name %>_virtual_path
  <% end %>
<% end %>
